services:
  configurator:
    command:
    - |
      ls -1 apps > sites/apps.txt;
      bench set-config -g db_host $$DB_HOST;
      bench set-config -gp db_port $$DB_PORT;
      bench set-config -g db_root_password $$DB_ROOT_PASSWORD;
      bench set-config -g redis_cache "redis://$$REDIS_CACHE";
      bench set-config -g redis_queue "redis://$$REDIS_QUEUE";
      bench set-config -g redis_socketio "redis://$$REDIS_QUEUE";
      bench set-config -gp socketio_port $$SOCKETIO_PORT;
      
      # Create new site if it doesn't exist
      if [ ! -d "sites/$$SITE_NAME" ]; then
        bench new-site --no-mariadb-socket --db-root-password=$$DB_ROOT_PASSWORD --admin-password=$$ADMIN_PASSWORD --install-app erpnext $$SITE_NAME || exit 1
        bench --site $$SITE_NAME migrate
        bench --site $$SITE_NAME build --force
      fi
    environment:
      DB_HOST: ${DB_HOST:-172.18.0.%}
      DB_PORT: ${DB_PORT:-3306}
      DB_ROOT_PASSWORD: ${DB_ROOT_PASSWORD:-123456}
      REDIS_CACHE: redis-cache:6379
      REDIS_QUEUE: redis-queue:6379
      SOCKETIO_PORT: "9000"
      SITE_NAME: ${FRAPPE_SITE_NAME_HEADER:-frappe}
      ADMIN_PASSWORD: ${ADMIN_PASSWORD:-admin}
    
    # Debugging
  db:
    command:
    - --character-set-server=utf8mb4
    - --collation-server=utf8mb4_unicode_ci
    - --skip-character-set-client-handshake
    - --skip-innodb-read-only-compressed
    # Add these connection-related settings
    - --max_allowed_packet=128M
    - --wait_timeout=28800
    - --interactive_timeout=28800
    - --net_read_timeout=60
    - --net_write_timeout=60
    environment:
      MYSQL_ROOT_PASSWORD: ${DB_ROOT_PASSWORD:-123456}
      # MariaDB Temporary Fix
      MARIADB_ROOT_PASSWORD: ${DB_ROOT_PASSWORD:-123456}
      # Allow connections from Docker network
      MYSQL_ROOT_HOST: "172.18.0.%"
      MYSQL_ALLOW_EMPTY_PASSWORD: "no"
      # Add these for more verbose logging
      MYSQL_LOG_CONSOLE: "true"
      MYSQL_LOG_ERROR: "true"
    # Modify healthcheck to be more lenient
    healthcheck:
      test:
      - CMD-SHELL
      - mysqladmin ping -h localhost --password=$$MYSQL_ROOT_PASSWORD
      interval: 5s
      timeout: 10s
      retries: 30